<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack ì•Œë¦¼ ëª¨ë‹ˆí„°ë§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .connection-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"], input[type="password"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        button.success {
            background: #27ae60;
        }

        button.success:hover {
            background: #229954;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        button.warning {
            background: #f39c12;
        }

        button.warning:hover {
            background: #d68910;
        }

        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status.monitoring {
            background: #d1ecf1;
            color: #0c5460;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification-item {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-item.priority-critical {
            background: #ffe5e5;
            border-left-color: #ff4444;
        }

        .notification-item.priority-high {
            background: #fff4e5;
            border-left-color: #ff9500;
        }

        .notification-item.priority-normal {
            background: #e8f4f8;
            border-left-color: #4facfe;
        }

        .notification-item.priority-low {
            background: #f5f5f5;
            border-left-color: #a8dadc;
        }

        .notification-item.read {
            background: white;
            border-left-color: #ddd;
            opacity: 0.7;
        }

        .notification-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-item.new {
            animation: blink 1s ease-in-out 3;
        }

        @keyframes blink {
            0%, 100% { background: #fff3cd; }
            50% { background: #ffe69c; }
        }

        .notification-item .time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .notification-item .channel {
            font-weight: 600;
            color: #3498db;
            margin-bottom: 5px;
        }

        .notification-item .reason {
            display: inline-block;
            padding: 2px 8px;
            background: #e74c3c;
            color: white;
            border-radius: 3px;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .priority-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .priority-badge.critical {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 68, 68, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        .priority-badge.high {
            background: linear-gradient(135deg, #ff9500 0%, #ff5e00 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(255, 149, 0, 0.3);
        }

        .priority-badge.normal {
            background: linear-gradient(135deg, #4facfe 0%, #00b4d8 100%);
            color: white;
        }

        .priority-badge.low {
            background: linear-gradient(135deg, #a8dadc 0%, #6c757d 100%);
            color: white;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(255, 68, 68, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 68, 68, 0.6);
            }
        }

        .priority-reason {
            display: block;
            font-size: 11px;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }

        .notification-link-btn {
            padding: 4px 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .notification-link-btn:hover {
            background: #2980b9;
        }

        .notification-item .text {
            color: #333;
            line-height: 1.5;
        }

        .message-item {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.5s ease;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-item .user {
            font-weight: 600;
            color: #2c3e50;
        }

        .message-item .user.bot {
            color: #9b59b6;
        }

        .message-item .time {
            font-size: 11px;
            color: #999;
            margin-left: 8px;
        }

        .message-item .text {
            margin-top: 5px;
            color: #555;
            line-height: 1.5;
        }

        .thread-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 10px;
            padding: 2px 8px;
            background: #f0f0f0;
            border-radius: 10px;
            font-size: 11px;
            color: #666;
            cursor: pointer;
            transition: background 0.2s;
        }

        .thread-indicator:hover {
            background: #e0e0e0;
        }

        .thread-replies {
            margin-left: 30px;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid #3498db;
            display: none;
        }

        .thread-replies.expanded {
            display: block;
        }

        .thread-reply {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .thread-reply:last-child {
            border-bottom: none;
        }

        .thread-loading {
            padding: 10px;
            text-align: center;
            color: #999;
            font-size: 12px;
        }

        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .user-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #e8f4f8;
            border: 1px solid #3498db;
            border-radius: 20px;
            font-size: 13px;
            color: #2c3e50;
        }

        .user-tag button {
            padding: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #e74c3c;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-user-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .message-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .notification-count {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .notification-section {
            margin-bottom: 25px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .notification-section .section-header {
            padding: 12px 20px;
            font-weight: 600;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-section .section-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .new-section .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .unread-section .section-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .read-section .section-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .notification-section .section-content {
            background: white;
            padding: 10px;
        }

        .notification-section .notification-item {
            margin-bottom: 8px;
            border-radius: 6px;
        }

        .notification-section .notification-item:last-child {
            margin-bottom: 0;
        }

        .new-section .notification-item {
            border-left-color: #667eea;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }

        .unread-section .notification-item {
            border-left-color: #f5576c;
        }

        .read-section .notification-item {
            border-left-color: #4facfe;
            opacity: 0.85;
        }

        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .sound-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .notification-memo {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            display: none;
        }

        .notification-memo.show {
            display: block;
        }

        .notification-memo textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .notification-memo .memo-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .notification-memo button {
            padding: 6px 12px;
            font-size: 12px;
        }

        .saved-memo {
            margin-top: 10px;
            padding: 8px 12px;
            background: #f0f8ff;
            border-left: 3px solid #3498db;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
            display: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .saved-memo:hover {
            background: #e0f0ff;
        }

        .saved-memo.show {
            display: block;
        }

        .saved-memo .memo-label {
            font-weight: 600;
            color: #3498db;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .saved-memo.editing {
            padding: 0;
            background: transparent;
            border: none;
        }

        .saved-memo.editing:hover {
            background: transparent;
        }

        .saved-memo .memo-edit-area {
            display: none;
        }

        .saved-memo.editing .memo-edit-area {
            display: block;
        }

        .saved-memo.editing .memo-content {
            display: none;
        }

        .saved-memo.editing .memo-label {
            display: none;
        }

        .saved-memo .memo-edit-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #3498db;
            border-radius: 4px;
            font-size: 13px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .saved-memo .memo-edit-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .saved-memo .memo-edit-buttons button {
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” Slack ì•Œë¦¼ ëª¨ë‹ˆí„°ë§</h1>

        <!-- ì—°ê²° ì„¹ì…˜ -->
        <div class="card">
            <h2>ğŸ”‘ Slack ì—°ê²°</h2>
            <div class="connection-section">
                <input type="password" id="tokenInput" placeholder="Slack Bot Token (xoxb-...)">
                <button id="connectBtn" onclick="connect()">ì—°ê²°</button>
                <button id="disconnectBtn" class="danger" onclick="disconnect()" style="display: none;">ì—°ê²° í•´ì œ</button>
                <span id="connectionStatus" class="status disconnected">ì—°ê²° ì•ˆë¨</span>
            </div>
            <div class="sound-toggle">
                <input type="checkbox" id="soundToggle" checked>
                <label for="soundToggle">ì•Œë¦¼ìŒ ì¬ìƒ</label>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('notifications')">ğŸ”” ì‹¤ì‹œê°„ ì•Œë¦¼</button>
            <button class="tab" onclick="switchTab('starred')">â­ ì¤‘ìš” ë©”ì‹œì§€</button>
            <button class="tab" onclick="switchTab('activity')">ğŸ“Œ ë‚´ í™œë™</button>
            <button class="tab" onclick="switchTab('messages')">ğŸ’¬ ì±„ë„ ë©”ì‹œì§€</button>
            <button class="tab" onclick="switchTab('users')">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab('settings')">âš™ï¸ ì„¤ì •</button>
        </div>

        <!-- ì‹¤ì‹œê°„ ì•Œë¦¼ íƒ­ -->
        <div id="notificationsTab" class="tab-content active">
            <div class="card">
                <h2>ì‹¤ì‹œê°„ ë©˜ì…˜ ëª¨ë‹ˆí„°ë§</h2>
                <div style="text-align: center; margin-bottom: 15px;">
                    <button id="startMonitoringBtn" class="success" onclick="startMonitoring()">â–¶ï¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
                    <button id="stopMonitoringBtn" class="danger" onclick="stopMonitoring()" style="display: none;">â¸ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
                    <button id="testNotificationBtn" class="warning" onclick="testNotification()" style="display: none; margin-left: 10px;">ğŸ§ª í…ŒìŠ¤íŠ¸ ì•Œë¦¼</button>
                    <span id="monitoringStatus"></span>
                </div>

                <!-- ìƒˆ ì•Œë¦¼ ì„¹ì…˜ -->
                <div class="notification-section new-section" id="newNotifications" style="display: none;">
                    <div class="section-header">
                        <h3>ğŸ”” ìƒˆ ì•Œë¦¼ (<span id="newCount">0</span>)</h3>
                    </div>
                    <div class="section-content" id="newNotificationList"></div>
                </div>

                <!-- ì•ˆ ì½ì€ ì•Œë¦¼ ì„¹ì…˜ -->
                <div class="notification-section unread-section" id="unreadNotifications" style="display: none;">
                    <div class="section-header">
                        <h3>ğŸ“¬ ì•ˆ ì½ì€ ì•Œë¦¼ (<span id="unreadCount">0</span>)</h3>
                    </div>
                    <div class="section-content" id="unreadNotificationList"></div>
                </div>

                <!-- ì½ì€ ì•Œë¦¼ ì„¹ì…˜ -->
                <div class="notification-section read-section" id="readNotifications" style="display: none;">
                    <div class="section-header">
                        <h3>âœ… ì½ì€ ì•Œë¦¼ (<span id="readCount">0</span>)</h3>
                    </div>
                    <div class="section-content" id="readNotificationList"></div>
                </div>

                <!-- ì•Œë¦¼ ì—†ìŒ ìƒíƒœ -->
                <div class="notification-count" id="notificationCount">ì•Œë¦¼ ëŒ€ê¸° ì¤‘...</div>
            </div>
        </div>

        <!-- ì¤‘ìš” ë©”ì‹œì§€ íƒ­ -->
        <div id="starredTab" class="tab-content">
            <div class="card">
                <h2>â­ ì¤‘ìš” ë©”ì‹œì§€</h2>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    ë³„í‘œë¡œ ì €ì¥í•œ ì¤‘ìš”í•œ ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <button class="success" onclick="loadStarredMessages()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="starredList" style="margin-top: 20px;">
                <p style="text-align: center; color: #999; padding: 40px;">ì €ì¥ëœ ì¤‘ìš” ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- ë‚´ í™œë™ íƒ­ -->
        <div id="activityTab" class="tab-content">
            <div class="card">
                <h2>ë‚´ í™œë™ (ë‚˜ì—ê²Œ ì˜¨ ë©˜ì…˜)</h2>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    ë‚˜ì—ê²Œ ì§ì ‘ ì˜¨ ë©˜ì…˜ê³¼ ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="message-controls">
                    <button onclick="loadMyActivity(50)">ğŸ“¥ ìµœê·¼ 50ê°œ</button>
                    <button onclick="loadMyActivity(100)">ğŸ“¥ ìµœê·¼ 100ê°œ</button>
                    <button onclick="loadMyActivity(200)">ğŸ“¥ ìµœê·¼ 200ê°œ</button>
                </div>
                <div id="activityList"></div>
            </div>
        </div>

        <!-- ì±„ë„ ë©”ì‹œì§€ íƒ­ -->
        <div id="messagesTab" class="tab-content">
            <div class="card">
                <h2>ì±„ë„ ë©”ì‹œì§€ ì¡°íšŒ</h2>
                <div class="message-controls">
                    <select id="channelSelect">
                        <option value="">ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                    <button onclick="loadMessages(50)">ğŸ“¥ ìµœê·¼ 50ê°œ</button>
                    <button onclick="loadMessages(100)">ğŸ“¥ ìµœê·¼ 100ê°œ</button>
                    <button onclick="loadMessages(200)">ğŸ“¥ ìµœê·¼ 200ê°œ</button>
                </div>
                <div id="messageList"></div>
            </div>
        </div>

        <!-- ì‚¬ìš©ì ê´€ë¦¬ íƒ­ -->
        <div id="usersTab" class="tab-content">
            <div class="card">
                <h2>ëª¨ë‹ˆí„°ë§ ì‚¬ìš©ì ê´€ë¦¬</h2>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    íŠ¹ì • ì‚¬ìš©ìê°€ ë©˜ì…˜ë˜ì—ˆì„ ë•Œ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="add-user-section">
                    <input type="text" id="userInput" placeholder="ì‚¬ìš©ì ì´ë¦„ ë˜ëŠ” ID ì…ë ¥ (ì˜ˆ: aiden, U07R293JDV4)">
                    <button class="success" onclick="addUser()">â• ì¶”ê°€</button>
                </div>
                <div id="userList" class="user-list"></div>
            </div>
        </div>

        <!-- ì„¤ì • íƒ­ -->
        <div id="settingsTab" class="tab-content">
            <!-- ì¼ë°˜ ì„¤ì • -->
            <div class="card">
                <h2>âš™ï¸ ì¼ë°˜ ì„¤ì •</h2>
                <p style="margin-bottom: 20px; color: #666; font-size: 14px;">
                    ê°œì¸ë³„ ì•Œë¦¼ ì„¤ì •ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>

                <div style="margin-bottom: 20px;">
                    <div class="sound-toggle" style="margin-top: 0;">
                        <input type="checkbox" id="settingNotificationSound" checked>
                        <label for="settingNotificationSound">ì•Œë¦¼ìŒ ì¬ìƒ</label>
                    </div>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #333;">âš¡ ì ì‘í˜• í´ë§ (ìë™ ìµœì í™”)</div>
                    <div style="font-size: 13px; color: #666; line-height: 1.6;">
                        â€¢ ì•Œë¦¼ ë§ì„ ë•Œ: <strong>0.2ì´ˆ</strong> ê°„ê²© (ë¹ ë¦„) âš¡<br>
                        â€¢ í™œë™ ì¤‘: <strong>0.5ì´ˆ</strong> ê°„ê²© (ì¼ë°˜) ğŸ“Š<br>
                        â€¢ ì¡°ìš©í•  ë•Œ: <strong>0.8ì´ˆ</strong> ê°„ê²© (ê· í˜•) ğŸ’¤<br>
                        <span style="color: #4CAF50; margin-top: 5px; display: inline-block;">âœ“ API ë¶€ë‹´ì„ ìµœì†Œí™”í•˜ë©´ì„œ ë¹ ë¥¸ ì•Œë¦¼ ì œê³µ</span>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button class="success" onclick="saveSettings()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
                </div>
            </div>

            <!-- ìš°ì„ ìˆœìœ„ í‚¤ì›Œë“œ -->
            <div class="card">
                <h2>ğŸ¯ ìš°ì„ ìˆœìœ„ í‚¤ì›Œë“œ ê´€ë¦¬</h2>
                <p style="margin-bottom: 20px; color: #666; font-size: 14px;">
                    ë©”ì‹œì§€ ìš°ì„ ìˆœìœ„ë¥¼ ê²°ì •í•˜ëŠ” í‚¤ì›Œë“œë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>

                <!-- Critical í‚¤ì›Œë“œ -->
                <div style="margin-bottom: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span class="priority-badge critical">ğŸ”´ CRITICAL</span>
                        <span style="font-size: 14px; color: #666;">(ì¦‰ì‹œ ëŒ€ì‘ í•„ìš”)</span>
                    </h3>
                    <div class="add-user-section">
                        <input type="text" id="criticalKeywordInput" placeholder="í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: ì‹¬ê°, severe)">
                        <button class="danger" onclick="addKeyword('critical')">â• ì¶”ê°€</button>
                    </div>
                    <div id="criticalKeywordList" class="user-list"></div>
                </div>

                <!-- High í‚¤ì›Œë“œ -->
                <div style="margin-bottom: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span class="priority-badge high">ğŸŸ  HIGH</span>
                        <span style="font-size: 14px; color: #666;">(ë¹ ë¥¸ ë‹µë³€ í•„ìš”)</span>
                    </h3>
                    <div class="add-user-section">
                        <input type="text" id="highKeywordInput" placeholder="í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: ìš”ì²­, request)">
                        <button class="warning" onclick="addKeyword('high')">â• ì¶”ê°€</button>
                    </div>
                    <div id="highKeywordList" class="user-list"></div>
                </div>

                <!-- Normal í‚¤ì›Œë“œ -->
                <div style="margin-bottom: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span class="priority-badge normal">ğŸ”µ NORMAL</span>
                        <span style="font-size: 14px; color: #666;">(ì¼ë°˜ ë©”ì‹œì§€)</span>
                    </h3>
                    <div class="add-user-section">
                        <input type="text" id="normalKeywordInput" placeholder="í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: ì •ë³´, info)">
                        <button onclick="addKeyword('normal')">â• ì¶”ê°€</button>
                    </div>
                    <div id="normalKeywordList" class="user-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let connected = false;
        let monitoring = false;
        let eventSource = null;
        let channelEventSource = null;
        let currentChannelId = null;
        let sessionId = Date.now().toString();
        let notificationCount = 0;
        let audioContext = null;
        let notificationStates = {}; // ì•Œë¦¼ ìƒíƒœ ì¶”ì  {notifId: 'new'|'unread'|'read'}
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectDelay = 2000; // 2ì´ˆ

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const STORAGE_KEY = 'slack_notifications';
        const STORAGE_STATES_KEY = 'slack_notification_states';

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadNotificationsFromStorage() {
            try {
                const savedNotifications = localStorage.getItem(STORAGE_KEY);
                const savedStates = localStorage.getItem(STORAGE_STATES_KEY);

                if (savedNotifications && savedStates) {
                    const notifications = JSON.parse(savedNotifications);
                    notificationStates = JSON.parse(savedStates);

                    // ì €ì¥ëœ ì•Œë¦¼ë“¤ì„ ê° ì„¹ì…˜ì— ì¶”ê°€
                    notifications.forEach(notif => {
                        try {
                            addNotificationToDOM(notif);
                        } catch (err) {
                            console.error('ì•Œë¦¼ ë³µì› ì‹¤íŒ¨:', notif.id, err);
                        }
                    });

                    updateSectionCounts();
                    console.log(`âœ… ${notifications.length}ê°œì˜ ì €ì¥ëœ ì•Œë¦¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                }
            } catch (e) {
                console.error('ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
                // ì—ëŸ¬ê°€ ìˆì–´ë„ localStorage í´ë¦¬ì–´í•˜ê³  ê³„ì† ì§„í–‰
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(STORAGE_STATES_KEY);
            }
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì•Œë¦¼ ì €ì¥
        function saveNotificationsToStorage() {
            try {
                // ëª¨ë“  ì•Œë¦¼ ë°ì´í„°ë¥¼ ìˆ˜ì§‘
                const allNotifications = [];
                ['new', 'unread', 'read'].forEach(state => {
                    const list = document.getElementById(`${state}NotificationList`);
                    if (list) {
                        const notifs = list.querySelectorAll('.notification-item');
                        notifs.forEach(notifEl => {
                            try {
                                const notifData = {
                                    id: notifEl.id,
                                    html: notifEl.outerHTML,
                                    state: state
                                };
                                allNotifications.push(notifData);
                            } catch (err) {
                                console.error('ì•Œë¦¼ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨:', notifEl.id, err);
                            }
                        });
                    }
                });

                localStorage.setItem(STORAGE_KEY, JSON.stringify(allNotifications));
                localStorage.setItem(STORAGE_STATES_KEY, JSON.stringify(notificationStates));
            } catch (e) {
                console.error('ì•Œë¦¼ ì €ì¥ ì‹¤íŒ¨:', e);
                // localStorage quota ì´ˆê³¼ ë“±ì˜ ì—ëŸ¬ ë°œìƒ ì‹œ ì˜¤ë˜ëœ ë°ì´í„° ì‚­ì œ
                try {
                    localStorage.removeItem(STORAGE_KEY);
                    localStorage.removeItem(STORAGE_STATES_KEY);
                } catch (clearErr) {
                    console.error('localStorage í´ë¦¬ì–´ ì‹¤íŒ¨:', clearErr);
                }
            }
        }

        // ì €ì¥ëœ ì•Œë¦¼ì„ DOMì— ì¶”ê°€í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function addNotificationToDOM(notifData) {
            const state = notifData.state;
            const list = document.getElementById(`${state}NotificationList`);
            if (!list) return;

            // HTMLì—ì„œ DOM ìš”ì†Œ ìƒì„±
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = notifData.html;
            const notifEl = tempDiv.firstElementChild;

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ì„¤ì •
            const notifId = notifEl.id;

            // í´ë¦­ ì´ë²¤íŠ¸
            notifEl.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'A') {
                    e.stopPropagation();
                    return;
                }
                toggleNotificationRead(notifId);
            });

            // Ctrl+Enter í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ìƒˆ ë©”ëª¨)
            const textarea = notifEl.querySelector(`#textarea-${notifId}`);
            if (textarea) {
                textarea.addEventListener('keydown', function(e) {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        saveMemo(notifId);
                    }
                });
            }

            // Ctrl+Enter í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ë©”ëª¨ ìˆ˜ì •)
            const editTextarea = notifEl.querySelector(`#edit-textarea-${notifId}`);
            if (editTextarea) {
                editTextarea.addEventListener('keydown', function(e) {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        updateMemo(notifId);
                    }
                });
            }

            // ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
            list.appendChild(notifEl);
        }

        // ì„¹ì…˜ë³„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateSectionCounts() {
            const newCount = Object.values(notificationStates).filter(s => s === 'new').length;
            const unreadCount = Object.values(notificationStates).filter(s => s === 'unread').length;
            const readCount = Object.values(notificationStates).filter(s => s === 'read').length;

            document.getElementById('newCount').textContent = newCount;
            document.getElementById('unreadCount').textContent = unreadCount;
            document.getElementById('readCount').textContent = readCount;

            // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
            document.getElementById('newNotifications').style.display = newCount > 0 ? 'block' : 'none';
            document.getElementById('unreadNotifications').style.display = unreadCount > 0 ? 'block' : 'none';
            document.getElementById('readNotifications').style.display = readCount > 0 ? 'block' : 'none';

            // ì•Œë¦¼ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ëŒ€ê¸° ë©”ì‹œì§€ í‘œì‹œ
            const totalCount = newCount + unreadCount + readCount;
            document.getElementById('notificationCount').style.display = totalCount === 0 ? 'block' : 'none';
        }

        // ì•Œë¦¼ì„ ì ì ˆí•œ ì„¹ì…˜ìœ¼ë¡œ ì´ë™
        function moveNotificationToSection(notifId, newState) {
            const oldState = notificationStates[notifId];
            if (oldState === newState) return;

            const notifElement = document.getElementById(notifId);
            if (!notifElement) return;

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            notificationStates[notifId] = newState;

            // ì ì ˆí•œ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
            let targetList;
            if (newState === 'new') {
                targetList = document.getElementById('newNotificationList');
            } else if (newState === 'unread') {
                targetList = document.getElementById('unreadNotificationList');
            } else {
                targetList = document.getElementById('readNotificationList');
            }

            // ë¦¬ìŠ¤íŠ¸ ë§¨ ìœ„ì— ì¶”ê°€
            targetList.insertBefore(notifElement, targetList.firstChild);

            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            updateSectionCounts();

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            saveNotificationsToStorage();
        }

        // ì•Œë¦¼ìŒ ì¬ìƒ í•¨ìˆ˜
        function playNotificationSound() {
            if (!document.getElementById('soundToggle').checked) return;

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Slack ì—°ê²°
        async function connect() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                alert('í† í°ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            const btn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            btn.disabled = true;
            btn.textContent = 'ì—°ê²° ì¤‘...';

            try {
                const response = await fetch('/api/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({token})
                });

                const result = await response.json();

                if (result.success) {
                    connected = true;

                    // localStorageì— í† í° ì €ì¥
                    localStorage.setItem('slack_token', token);

                    document.getElementById('connectionStatus').textContent = `ì—°ê²°ë¨ (${result.user})`;
                    document.getElementById('connectionStatus').className = 'status connected';
                    btn.style.display = 'none';
                    disconnectBtn.style.display = 'inline-block';
                    document.getElementById('tokenInput').disabled = true;

                    // ì±„ë„ ëª©ë¡ ë¡œë“œ
                    loadChannels();
                    loadWatchedUsers();
                } else {
                    alert('ì—°ê²° ì‹¤íŒ¨: ' + result.error);
                    btn.disabled = false;
                    btn.textContent = 'ì—°ê²°';
                }
            } catch (error) {
                alert('ì—°ê²° ì˜¤ë¥˜: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'ì—°ê²°';
            }
        }

        // ì—°ê²° í•´ì œ
        function disconnect() {
            // localStorageì—ì„œ í† í° ì‚­ì œ
            localStorage.removeItem('slack_token');

            // UI ì´ˆê¸°í™”
            connected = false;
            document.getElementById('connectionStatus').textContent = 'ì—°ê²° ì•ˆë¨';
            document.getElementById('connectionStatus').className = 'status disconnected';
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('connectBtn').textContent = 'ì—°ê²°';
            document.getElementById('connectBtn').className = '';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('tokenInput').disabled = false;
            document.getElementById('tokenInput').value = '';

            // ì±„ë„ ëª©ë¡ ì´ˆê¸°í™”
            document.getElementById('channelSelect').innerHTML = '<option value="">ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            document.getElementById('messageList').innerHTML = '<div class="empty-state">Slackì— ì—°ê²°í•˜ì„¸ìš”</div>';
            document.getElementById('activityList').innerHTML = '<div class="empty-state">Slackì— ì—°ê²°í•˜ì„¸ìš”</div>';

            // ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            if (channelEventSource) {
                channelEventSource.close();
                channelEventSource = null;
            }

            alert('ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²°
        window.addEventListener('DOMContentLoaded', function() {
            // ì €ì¥ëœ ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸°
            loadNotificationsFromStorage();

            // ì €ì¥ëœ í† í°ìœ¼ë¡œ ìë™ ì—°ê²°
            const savedToken = localStorage.getItem('slack_token');
            if (savedToken) {
                document.getElementById('tokenInput').value = savedToken;
                connect();
            }
        });

        // ì±„ë„ ëª©ë¡ ë¡œë“œ
        async function loadChannels() {
            try {
                const response = await fetch('/api/channels');
                const result = await response.json();

                if (result.success) {
                    const select = document.getElementById('channelSelect');
                    select.innerHTML = '';

                    if (result.channels.length > 0) {
                        // ì²« ë²ˆì§¸ ì±„ë„ì„ ë””í´íŠ¸ë¡œ ì„ íƒ
                        result.channels.forEach((ch, index) => {
                            const option = document.createElement('option');
                            option.value = ch.id;
                            option.textContent = `# ${ch.name}`;
                            if (index === 0) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });

                        // ì²« ë²ˆì§¸ ì±„ë„ì˜ ë©”ì‹œì§€ ìë™ ë¡œë“œ
                        setTimeout(() => {
                            loadMessages(50);
                        }, 100);
                    } else {
                        select.innerHTML = '<option value="">ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                    }
                }
            } catch (error) {
                console.error('ì±„ë„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë©”ì‹œì§€ ë¡œë“œ
        async function loadMessages(limit) {
            const channelId = document.getElementById('channelSelect').value;
            if (!channelId) {
                alert('ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '<div class="loading">ë©”ì‹œì§€ ë¡œë”© ì¤‘...</div>';

            // currentChannelId ë¨¼ì € ì„¤ì •
            currentChannelId = channelId;

            // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            if (channelEventSource) {
                channelEventSource.close();
                channelEventSource = null;
            }

            try {
                const response = await fetch(`/api/messages/${channelId}?limit=${limit}`);
                const result = await response.json();

                if (result.success) {
                    if (result.messages.length === 0) {
                        messageList.innerHTML = '<div class="empty-state">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                        return;
                    }

                    messageList.innerHTML = '';
                    // ìµœì‹  ë©”ì‹œì§€ë¶€í„° í‘œì‹œ
                    result.messages.forEach(msg => {
                        addMessageToList(msg, false); // í•˜ì´ë¼ì´íŠ¸ ì—†ì´ ì¶”ê°€
                    });

                    // ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘
                    startChannelStream(channelId);
                }
            } catch (error) {
                messageList.innerHTML = '<div class="empty-state">ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜</div>';
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë‚´ í™œë™ ë©”ì‹œì§€ ë¡œë“œ
        async function loadMyActivity(limit) {
            const activityList = document.getElementById('activityList');
            activityList.innerHTML = '<div class="loading">ë‚´ í™œë™ ë¡œë”© ì¤‘...</div>';

            try {
                const response = await fetch(`/api/my-activity?limit=${limit}`);
                const result = await response.json();

                if (result.success) {
                    if (result.messages.length === 0) {
                        activityList.innerHTML = '<div class="empty-state">ë‚´ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                        return;
                    }

                    activityList.innerHTML = '';
                    result.messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'message-item';

                        const userName = msg.user_name || 'Unknown';
                        const isBot = msg.is_bot ? ' bot' : '';
                        const time = new Date(parseFloat(msg.ts) * 1000).toLocaleString('ko-KR');
                        const channelName = msg.channel_name || msg.channel?.name || 'Unknown';
                        const activityIcon = msg.activity_icon || 'ğŸ“‹';
                        const activityType = msg.activity_type || 'í™œë™';

                        div.innerHTML = `
                            <div>
                                <span style="font-size: 16px; margin-right: 5px;">${activityIcon}</span>
                                <span class="channel">#${channelName}</span>
                                <span class="user${isBot}">${userName}</span>
                                <span class="time">${time}</span>
                                <span class="reason" style="margin-left: 10px;">${activityType}</span>
                            </div>
                            <div class="text">${msg.text || '(ë‚´ìš© ì—†ìŒ)'}</div>
                        `;

                        activityList.appendChild(div);
                    });
                } else {
                    activityList.innerHTML = `<div class="empty-state">ì˜¤ë¥˜: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</div>`;
                }
            } catch (error) {
                activityList.innerHTML = '<div class="empty-state">ë‚´ í™œë™ ë¡œë“œ ì˜¤ë¥˜</div>';
                console.error('ë‚´ í™œë™ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë©”ì‹œì§€ë¥¼ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function addMessageToList(msg, highlight = true) {
            const messageList = document.getElementById('messageList');
            const div = document.createElement('div');
            div.className = 'message-item';

            const userName = msg.user_name || 'Unknown';
            const isBot = msg.is_bot ? ' bot' : '';
            const time = new Date(parseFloat(msg.ts) * 1000).toLocaleString('ko-KR');

            // ìŠ¤ë ˆë“œ ì •ë³´ ì¶”ê°€
            let threadIndicator = '';
            if (msg.has_thread && msg.reply_count > 0) {
                threadIndicator = `
                    <span class="thread-indicator" onclick="toggleThread('${currentChannelId}', '${msg.thread_ts}', this)">
                        ğŸ’¬ ${msg.reply_count}ê°œ ë‹µê¸€
                    </span>
                `;
            }

            div.innerHTML = `
                <div>
                    <span class="user${isBot}">${userName}</span>
                    <span class="time">${time}</span>
                    ${threadIndicator}
                </div>
                <div class="text">${msg.text || '(ë‚´ìš© ì—†ìŒ)'}</div>
                <div class="thread-replies" id="thread-${msg.ts}"></div>
            `;

            // ì´ˆê¸° ë¡œë“œ ì‹œì—ëŠ” ë§¨ ì•„ë˜ì— ì¶”ê°€ (appendChild)
            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì—ëŠ” ë§¨ ìœ„ì— ì¶”ê°€ (insertBefore)
            if (highlight) {
                // ì‹¤ì‹œê°„ ìƒˆ ë©”ì‹œì§€ - ë§¨ ìœ„ì— ì¶”ê°€
                messageList.insertBefore(div, messageList.firstChild);

                // ìƒˆ ë©”ì‹œì§€ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
                div.style.backgroundColor = '#e8f4f8';
                setTimeout(() => {
                    div.style.backgroundColor = '';
                }, 2000);
            } else {
                // ì´ˆê¸° ë¡œë“œ - ë§¨ ì•„ë˜ì— ì¶”ê°€ (ìµœì‹  ìˆœì„œ ìœ ì§€)
                messageList.appendChild(div);
            }
        }

        // ì±„ë„ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘
        function startChannelStream(channelId) {
            currentChannelId = channelId;

            console.log('ì±„ë„ ìŠ¤íŠ¸ë¦¼ ì‹œì‘:', channelId);

            // SSE ì—°ê²°
            channelEventSource = new EventSource(`/api/channel/stream/${channelId}`);

            channelEventSource.onopen = function() {
                console.log('ì±„ë„ SSE ì—°ê²° ì„±ê³µ');
            };

            channelEventSource.onmessage = function(event) {
                console.log('ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);
                const msg = JSON.parse(event.data);

                if (msg.error) {
                    console.error('ì±„ë„ ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜:', msg.error);
                    return;
                }

                // ìƒˆ ë©”ì‹œì§€ ì¶”ê°€
                addMessageToList(msg, true);
            };

            channelEventSource.onerror = function(err) {
                console.error('ì±„ë„ SSE ì—°ê²° ì˜¤ë¥˜:', err);
            };
        }

        // ì±„ë„ ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì§€
        function stopChannelStream() {
            if (channelEventSource) {
                channelEventSource.close();
                channelEventSource = null;
                currentChannelId = null;
            }
        }

        // ìŠ¤ë ˆë“œ í¼ì¹˜ê¸°/ì ‘ê¸°
        async function toggleThread(channelId, threadTs, element) {
            const threadContainer = document.getElementById(`thread-${threadTs}`);

            if (!threadContainer) {
                console.error('ìŠ¤ë ˆë“œ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            // ì´ë¯¸ í¼ì³ì ¸ ìˆìœ¼ë©´ ì ‘ê¸°
            if (threadContainer.classList.contains('expanded')) {
                threadContainer.classList.remove('expanded');
                element.innerHTML = `ğŸ’¬ ${element.textContent.match(/\d+/)[0]}ê°œ ë‹µê¸€`;
                return;
            }

            // ë¡œë”© í‘œì‹œ
            threadContainer.innerHTML = '<div class="thread-loading">ë‹µê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            threadContainer.classList.add('expanded');
            element.innerHTML = `ğŸ’¬ ${element.textContent.match(/\d+/)[0]}ê°œ ë‹µê¸€ (ì ‘ê¸°)`;

            try {
                const response = await fetch(`/api/thread/${channelId}/${threadTs}`);
                const result = await response.json();

                if (result.success && result.replies && result.replies.length > 0) {
                    threadContainer.innerHTML = '';

                    result.replies.forEach(reply => {
                        const replyDiv = document.createElement('div');
                        replyDiv.className = 'thread-reply';

                        const userName = reply.user_name || 'Unknown';
                        const isBot = reply.is_bot ? ' bot' : '';
                        const time = new Date(parseFloat(reply.ts) * 1000).toLocaleString('ko-KR');

                        replyDiv.innerHTML = `
                            <div>
                                <span class="user${isBot}">${userName}</span>
                                <span class="time">${time}</span>
                            </div>
                            <div class="text">${reply.text || '(ë‚´ìš© ì—†ìŒ)'}</div>
                        `;

                        threadContainer.appendChild(replyDiv);
                    });
                } else {
                    threadContainer.innerHTML = '<div class="thread-loading">ë‹µê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                }
            } catch (error) {
                console.error('ìŠ¤ë ˆë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                threadContainer.innerHTML = '<div class="thread-loading">ë‹µê¸€ ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        // SSE ì—°ê²° í•¨ìˆ˜ (ì¬ì—°ê²° ë¡œì§ í¬í•¨)
        function connectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            console.log(`ğŸ”Œ SSE ì—°ê²° ì‹œë„ ì¤‘... (ì‹œë„ ${reconnectAttempts + 1}/${maxReconnectAttempts})`);

            // ì—°ê²° ìƒíƒœ í‘œì‹œ
            document.getElementById('monitoringStatus').textContent = 'ì—°ê²° ì¤‘...';
            document.getElementById('monitoringStatus').className = 'status monitoring';

            eventSource = new EventSource(`/api/monitoring/events?session_id=${sessionId}`);

            eventSource.onopen = function() {
                console.log('âœ… SSE ì—°ê²° ì„±ê³µ');
                reconnectAttempts = 0; // ì„±ê³µ ì‹œ ì¹´ìš´í„° ë¦¬ì…‹
                document.getElementById('monitoringStatus').textContent = '';
            };

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.error) {
                    console.error('ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜:', data.error);
                    alert('ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: ' + data.error);
                    stopMonitoring();
                    return;
                }

                // ìƒˆ ì•Œë¦¼ í‘œì‹œ
                addNotification(data);

                // ì•Œë¦¼ìŒ ì¬ìƒ
                playNotificationSound();

                // ë¸Œë¼ìš°ì € ì•Œë¦¼
                if (Notification.permission === 'granted') {
                    new Notification('ìƒˆë¡œìš´ Slack ë©˜ì…˜', {
                        body: `${data.channel}: ${data.text.substring(0, 50)}...`,
                        icon: '/static/icon.png'
                    });
                }
            };

            eventSource.onerror = function(error) {
                console.error('âŒ SSE ì—°ê²° ì˜¤ë¥˜:', error);

                // EventSourceëŠ” ìë™ìœ¼ë¡œ ì¬ì—°ê²°ì„ ì‹œë„í•˜ì§€ë§Œ, ì„œë²„ê°€ ì™„ì „íˆ ë‹¤ìš´ëœ ê²½ìš°ë¥¼ ëŒ€ë¹„
                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('SSE ì—°ê²°ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì‹œë„...');

                    if (monitoring && reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        document.getElementById('monitoringStatus').textContent = `ì¬ì—°ê²° ì¤‘... (${reconnectAttempts}/${maxReconnectAttempts})`;

                        setTimeout(() => {
                            if (monitoring) {
                                connectSSE();
                            }
                        }, reconnectDelay * reconnectAttempts);
                    } else if (reconnectAttempts >= maxReconnectAttempts) {
                        alert('SSE ì—°ê²° ì‹¤íŒ¨: ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ ì´ˆê³¼. ëª¨ë‹ˆí„°ë§ì„ ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.');
                        stopMonitoring();
                    }
                }
            };
        }

        // ëª¨ë‹ˆí„°ë§ ì‹œì‘
        async function startMonitoring() {
            if (!connected) {
                alert('ë¨¼ì € Slackì— ì—°ê²°í•˜ì„¸ìš”');
                return;
            }

            try {
                await fetch('/api/monitoring/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: sessionId})
                });

                monitoring = true;
                reconnectAttempts = 0;
                notificationCount = 0;
                document.getElementById('notificationCount').textContent = 'ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘...';
                document.getElementById('startMonitoringBtn').style.display = 'none';
                document.getElementById('stopMonitoringBtn').style.display = 'inline-block';
                document.getElementById('testNotificationBtn').style.display = 'inline-block';

                // SSE ì—°ê²° ì‹œì‘
                connectSSE();

                // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                }

            } catch (error) {
                alert('ëª¨ë‹ˆí„°ë§ ì‹œì‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
        async function stopMonitoring() {
            try {
                await fetch('/api/monitoring/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: sessionId})
                });

                monitoring = false;
                document.getElementById('startMonitoringBtn').style.display = 'inline-block';
                document.getElementById('stopMonitoringBtn').style.display = 'none';
                document.getElementById('testNotificationBtn').style.display = 'none';
                document.getElementById('monitoringStatus').textContent = '';

                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }

            } catch (error) {
                alert('ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ìƒì„±
        async function testNotification() {
            if (!monitoring) {
                alert('ë¨¼ì € ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch('/api/monitoring/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: sessionId})
                });

                const result = await response.json();
                if (result.success) {
                    // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì€ SSE ìŠ¤íŠ¸ë¦¼ì„ í†µí•´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤
                } else {
                    alert('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                alert('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ì•Œë¦¼ ì¶”ê°€
        function addNotification(data) {
            const div = document.createElement('div');
            const notifId = `notif-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            // ìš°ì„ ìˆœìœ„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const priority = data.priority || 'normal';
            const priorityReason = data.priority_reason || '';

            // ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ì¶”ê°€
            div.className = `notification-item new priority-${priority}`;
            div.id = notifId;

            // ë³„í‘œìš© ë°ì´í„° ì†ì„± ì €ì¥
            div.setAttribute('data-channel-id', data.channel_id || '');
            div.setAttribute('data-channel-name', data.channel || '');
            div.setAttribute('data-ts', data.ts || '');
            div.setAttribute('data-user', data.user || '');
            div.setAttribute('data-text', data.text || '');
            div.setAttribute('data-time', data.time || '');
            div.setAttribute('data-reason', data.reason || '');
            div.setAttribute('data-priority', data.priority || 'normal');

            // ë©”ì‹œì§€ ë§í¬ ë²„íŠ¼ ìƒì„±
            const linkButton = data.message_link
                ? `<a href="${data.message_link}" target="_blank" class="notification-link-btn" onclick="event.stopPropagation()">ğŸ”— Slackì—ì„œ ë³´ê¸°</a>`
                : '';

            // ìš°ì„ ìˆœìœ„ ì´ëª¨ì§€ ë§¤í•‘
            const priorityEmoji = {
                'critical': 'ğŸ”´',
                'high': 'ğŸŸ ',
                'normal': 'ğŸ”µ',
                'low': 'âšª'
            };

            // ìš°ì„ ìˆœìœ„ ë°°ì§€ ìƒì„±
            const priorityBadge = `<span class="priority-badge ${priority}">${priorityEmoji[priority]} ${priority}</span>`;
            const priorityReasonText = priorityReason ? `<span class="priority-reason">ğŸ¤– ${priorityReason}</span>` : '';

            div.innerHTML = `
                <div class="notification-header">
                    <div>
                        <div class="time">${data.time}</div>
                        <div class="channel"># ${data.channel}</div>
                        <span class="reason">${data.reason}</span>
                        ${priorityBadge}
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="star-btn" onclick="event.stopPropagation(); toggleStar('${notifId}')"
                                id="star-${notifId}"
                                title="ì¤‘ìš” ë©”ì‹œì§€ë¡œ ì €ì¥"
                                style="background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; font-size: 24px; cursor: pointer; padding: 6px 12px; transition: all 0.2s;">â˜†</button>
                        ${linkButton}
                    </div>
                </div>
                <div><strong>${data.user}</strong>: ${data.text}</div>
                ${priorityReasonText}
                <div class="saved-memo" id="saved-${notifId}" onclick="editMemo('${notifId}')">
                    <div class="memo-label">ğŸ“ ë©”ëª¨ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</div>
                    <div class="memo-content"></div>
                    <div class="memo-edit-area">
                        <textarea class="memo-edit-textarea" id="edit-textarea-${notifId}"></textarea>
                        <div class="memo-edit-buttons">
                            <button class="success" onclick="event.stopPropagation(); updateMemo('${notifId}')">ì €ì¥</button>
                            <button onclick="event.stopPropagation(); cancelEditMemo('${notifId}')">ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>
                <div class="notification-memo" id="memo-${notifId}">
                    <textarea placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Ctrl+Enterë¡œ ì €ì¥)" id="textarea-${notifId}"></textarea>
                    <div class="memo-buttons">
                        <button class="success" onclick="saveMemo('${notifId}')">ì €ì¥</button>
                        <button onclick="closeMemo('${notifId}')">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;

            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            div.addEventListener('click', function(e) {
                // ë²„íŠ¼, textarea, ë§í¬(a íƒœê·¸) í´ë¦­ ì‹œì—ëŠ” ë¬´ì‹œ
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'A') {
                    e.stopPropagation();
                    return;
                }
                toggleNotificationRead(notifId);
            });

            // Ctrl+Enterë¡œ ì €ì¥í•˜ëŠ” í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì¶”ê°€ (ìƒˆ ë©”ëª¨)
            const textarea = div.querySelector(`#textarea-${notifId}`);
            textarea.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    saveMemo(notifId);
                }
            });

            // Ctrl+Enterë¡œ ì €ì¥í•˜ëŠ” í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì¶”ê°€ (ë©”ëª¨ ìˆ˜ì •)
            const editTextarea = div.querySelector(`#edit-textarea-${notifId}`);
            editTextarea.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    updateMemo(notifId);
                }
            });

            // ìƒˆ ì•Œë¦¼ ì„¹ì…˜ì— ì¶”ê°€
            const newNotificationList = document.getElementById('newNotificationList');
            newNotificationList.insertBefore(div, newNotificationList.firstChild);

            // ìƒíƒœ ì´ˆê¸°í™”
            notificationStates[notifId] = 'new';
            updateSectionCounts();

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            saveNotificationsToStorage();

            // ê¹œë°•ì„ íš¨ê³¼ í›„ ì œê±°í•˜ê³  ì•ˆ ì½ì€ ì•Œë¦¼ìœ¼ë¡œ ì´ë™
            setTimeout(() => {
                div.classList.remove('new');
                moveNotificationToSection(notifId, 'unread');
            }, 3000);
        }

        // ì•Œë¦¼ ì½ìŒ/ì•ˆì½ìŒ í† ê¸€
        function toggleNotificationRead(notifId) {
            const notifElement = document.getElementById(notifId);
            const memoElement = document.getElementById(`memo-${notifId}`);
            const savedMemoElement = document.getElementById(`saved-${notifId}`);
            const memoContent = savedMemoElement.querySelector('.memo-content');

            // ì½ìŒìœ¼ë¡œ í‘œì‹œ ë° ì½ì€ ì•Œë¦¼ ì„¹ì…˜ìœ¼ë¡œ ì´ë™
            if (!notifElement.classList.contains('read')) {
                notifElement.classList.add('read');
                moveNotificationToSection(notifId, 'read');
            }

            // ì´ë¯¸ ì €ì¥ëœ ë©”ëª¨ê°€ ìˆìœ¼ë©´ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
            if (savedMemoElement.classList.contains('show') && memoContent.textContent) {
                editMemo(notifId);
                return;
            }

            // ë©”ëª¨ ì…ë ¥ì°½ í† ê¸€
            if (memoElement.classList.contains('show')) {
                memoElement.classList.remove('show');
            } else {
                // ë‹¤ë¥¸ ë©”ëª¨ ì…ë ¥ì°½ ë‹«ê¸°
                document.querySelectorAll('.notification-memo.show').forEach(m => {
                    m.classList.remove('show');
                });

                memoElement.classList.add('show');
                // textareaì— í¬ì»¤ìŠ¤
                const textarea = memoElement.querySelector('textarea');
                if (textarea) {
                    setTimeout(() => textarea.focus(), 100);
                }
            }
        }

        // ë©”ëª¨ ì €ì¥
        function saveMemo(notifId) {
            const memoElement = document.getElementById(`memo-${notifId}`);
            const textarea = memoElement.querySelector('textarea');
            const memoText = textarea.value.trim();

            if (memoText) {
                const savedMemoElement = document.getElementById(`saved-${notifId}`);
                const memoContent = savedMemoElement.querySelector('.memo-content');
                memoContent.textContent = memoText;
                savedMemoElement.classList.add('show');

                // ë©”ëª¨ ì…ë ¥ì°½ ë‹«ê¸°
                memoElement.classList.remove('show');
                textarea.value = '';

                // localStorageì— ì €ì¥
                const memos = JSON.parse(localStorage.getItem('notification_memos') || '{}');
                memos[notifId] = {
                    text: memoText,
                    timestamp: Date.now()
                };
                localStorage.setItem('notification_memos', JSON.stringify(memos));

                // ì•Œë¦¼ ì „ì²´ ì €ì¥
                saveNotificationsToStorage();
            } else {
                alert('ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            }
        }

        // ë©”ëª¨ ì…ë ¥ì°½ ë‹«ê¸°
        function closeMemo(notifId) {
            const memoElement = document.getElementById(`memo-${notifId}`);
            memoElement.classList.remove('show');
        }

        // ë©”ëª¨ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
        function editMemo(notifId) {
            const savedMemoElement = document.getElementById(`saved-${notifId}`);
            const memoContent = savedMemoElement.querySelector('.memo-content');
            const editTextarea = document.getElementById(`edit-textarea-${notifId}`);

            // ê¸°ì¡´ ë©”ëª¨ ë‚´ìš©ì„ textareaì— ë¡œë“œ
            editTextarea.value = memoContent.textContent;

            // í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
            savedMemoElement.classList.add('editing');

            // textareaì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                editTextarea.focus();
            }, 100);
        }

        // ë©”ëª¨ ìˆ˜ì • ì €ì¥
        function updateMemo(notifId) {
            const savedMemoElement = document.getElementById(`saved-${notifId}`);
            const editTextarea = document.getElementById(`edit-textarea-${notifId}`);
            const memoContent = savedMemoElement.querySelector('.memo-content');
            const memoText = editTextarea.value.trim();

            if (memoText) {
                // ë©”ëª¨ ë‚´ìš© ì—…ë°ì´íŠ¸
                memoContent.textContent = memoText;

                // localStorageì— ì €ì¥
                const memos = JSON.parse(localStorage.getItem('notification_memos') || '{}');
                memos[notifId] = {
                    text: memoText,
                    timestamp: Date.now()
                };
                localStorage.setItem('notification_memos', JSON.stringify(memos));

                // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
                savedMemoElement.classList.remove('editing');

                // ì•Œë¦¼ ì „ì²´ ì €ì¥
                saveNotificationsToStorage();
            } else {
                // ë©”ëª¨ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì‚­ì œ
                if (confirm('ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    savedMemoElement.classList.remove('show', 'editing');
                    memoContent.textContent = '';

                    // localStorageì—ì„œë„ ì‚­ì œ
                    const memos = JSON.parse(localStorage.getItem('notification_memos') || '{}');
                    delete memos[notifId];
                    localStorage.setItem('notification_memos', JSON.stringify(memos));

                    // ì•Œë¦¼ ì „ì²´ ì €ì¥
                    saveNotificationsToStorage();
                }
            }
        }

        // ë©”ëª¨ í¸ì§‘ ì·¨ì†Œ
        function cancelEditMemo(notifId) {
            const savedMemoElement = document.getElementById(`saved-${notifId}`);
            savedMemoElement.classList.remove('editing');
        }

        // ì‚¬ìš©ì ì¶”ê°€
        async function addUser() {
            const user = document.getElementById('userInput').value.trim();
            if (!user) {
                alert('ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch('/api/users/watched', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user})
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('userInput').value = '';
                    loadWatchedUsers();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert('ì‚¬ìš©ì ì¶”ê°€ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ì‚¬ìš©ì ì œê±°
        async function removeUser(user) {
            try {
                const response = await fetch(`/api/users/watched/${encodeURIComponent(user)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    loadWatchedUsers();
                }
            } catch (error) {
                alert('ì‚¬ìš©ì ì œê±° ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ëª¨ë‹ˆí„°ë§ ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        async function loadWatchedUsers() {
            try {
                const response = await fetch('/api/users/watched');
                const result = await response.json();

                const list = document.getElementById('userList');

                if (result.success && result.users.length > 0) {
                    list.innerHTML = '';
                    result.users.forEach(user => {
                        const tag = document.createElement('div');
                        tag.className = 'user-tag';
                        tag.innerHTML = `
                            ${user}
                            <button onclick="removeUser('${user}')">Ã—</button>
                        `;
                        list.appendChild(tag);
                    });
                } else {
                    list.innerHTML = '<div class="empty-state">ëª¨ë‹ˆí„°ë§ ì¤‘ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // ë©”ì‹œì§€ íƒ­ì—ì„œ ë‚˜ê°ˆ ë•Œ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            if (currentChannelId && tabName !== 'messages') {
                stopChannelStream();
            }

            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ì„ íƒí•œ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // ì„¤ì • íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ í‚¤ì›Œë“œ ë° ì„¤ì • ë¡œë“œ
            if (tabName === 'settings') {
                loadKeywords();
                loadSettings();
            }

            // ì¤‘ìš” ë©”ì‹œì§€ íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ë³„í‘œ ë©”ì‹œì§€ ë¡œë“œ
            if (tabName === 'starred') {
                loadStarredMessages();
            }
        }

        // ì„¤ì • ì €ì¥
        async function saveSettings() {
            const settings = {
                notification_sound: document.getElementById('settingNotificationSound').checked
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({settings})
                });

                const result = await response.json();

                if (result.success) {
                    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                } else {
                    alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                alert('ì„¤ì • ì €ì¥ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ì„¤ì • ë¡œë“œ
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const result = await response.json();

                if (result.success) {
                    const settings = result.settings;
                    document.getElementById('settingNotificationSound').checked = settings.notification_sound !== false;
                }
            } catch (error) {
                console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // í‚¤ì›Œë“œ ëª©ë¡ ë¡œë“œ
        async function loadKeywords() {
            try {
                const response = await fetch('/api/priority/keywords');
                const result = await response.json();

                if (result.success) {
                    const keywords = result.keywords;

                    // Critical í‚¤ì›Œë“œ
                    renderKeywordList('critical', keywords.critical || []);

                    // High í‚¤ì›Œë“œ
                    renderKeywordList('high', keywords.high || []);

                    // Normal í‚¤ì›Œë“œ
                    renderKeywordList('normal', keywords.normal || []);
                }
            } catch (error) {
                console.error('í‚¤ì›Œë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderKeywordList(priority, keywords) {
            const listId = priority + 'KeywordList';
            const list = document.getElementById(listId);

            if (keywords.length === 0) {
                list.innerHTML = '<div class="empty-state">ë“±ë¡ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            list.innerHTML = '';
            keywords.forEach(keyword => {
                const tag = document.createElement('div');
                tag.className = 'user-tag';
                tag.innerHTML = `
                    ${keyword}
                    <button onclick="removeKeyword('${priority}', '${keyword}')">Ã—</button>
                `;
                list.appendChild(tag);
            });
        }

        // í‚¤ì›Œë“œ ì¶”ê°€
        async function addKeyword(priority) {
            const inputId = priority + 'KeywordInput';
            const keyword = document.getElementById(inputId).value.trim();

            if (!keyword) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`/api/priority/keywords/${priority}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({keyword})
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById(inputId).value = '';
                    loadKeywords();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert('í‚¤ì›Œë“œ ì¶”ê°€ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // í‚¤ì›Œë“œ ì œê±°
        async function removeKeyword(priority, keyword) {
            try {
                const response = await fetch(`/api/priority/keywords/${priority}/${encodeURIComponent(keyword)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    loadKeywords();
                }
            } catch (error) {
                alert('í‚¤ì›Œë“œ ì œê±° ì˜¤ë¥˜: ' + error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            // ì €ì¥ëœ í† í°ì´ ìˆìœ¼ë©´ ìë™ ì—°ê²° ì‹œë„ (ì„ íƒì‚¬í•­)
        };

        // ===== ë³„í‘œ ë©”ì‹œì§€ ê´€ë ¨ í•¨ìˆ˜ =====

        // ë³„í‘œ ë©”ì‹œì§€ ë¡œë“œ
        async function loadStarredMessages() {
            try {
                const response = await fetch('/api/starred');
                const data = await response.json();

                if (data.success) {
                    const starredList = document.getElementById('starredList');

                    if (data.messages && data.messages.length > 0) {
                        starredList.innerHTML = '';
                        data.messages.forEach(msg => {
                            starredList.appendChild(createStarredMessageCard(msg));
                        });
                    } else {
                        starredList.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ì €ì¥ëœ ì¤‘ìš” ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                } else {
                    console.error('ë³„í‘œ ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', data.error);
                }
            } catch (error) {
                console.error('ë³„í‘œ ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë³„í‘œ ë©”ì‹œì§€ ì¹´ë“œ ìƒì„±
        function createStarredMessageCard(msg) {
            const card = document.createElement('div');
            card.className = 'notification-card';
            card.style.backgroundColor = '#fffef5';
            card.style.borderLeft = '4px solid #ffc107';

            const time = new Date(msg.starred_at * 1000).toLocaleString('ko-KR');

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${msg.channel_name || 'Unknown Channel'}</div>
                        <div style="color: #666; font-size: 13px; margin-bottom: 8px;">${msg.user || 'Unknown User'}</div>
                        <div style="margin-bottom: 8px;">${escapeHtml(msg.text || '')}</div>
                        <div style="color: #999; font-size: 12px;">â­ ì €ì¥: ${time}</div>
                    </div>
                    <button class="delete" onclick="removeStarred('${msg.message_id}')" style="margin-left: 10px;">ğŸ—‘ï¸</button>
                </div>
            `;

            return card;
        }

        // ë³„í‘œ ì¶”ê°€
        async function addStarred(messageData) {
            try {
                console.log('API ìš”ì²­ ì „ì†¡:', messageData);

                const response = await fetch('/api/starred', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: messageData })
                });

                console.log('ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

                if (!response.ok) {
                    console.error('HTTP ì—ëŸ¬:', response.status);
                    const text = await response.text();
                    console.error('ì‘ë‹µ ë‚´ìš©:', text);
                    return false;
                }

                const data = await response.json();
                console.log('ì‘ë‹µ ë°ì´í„°:', data);

                if (data.success) {
                    console.log('âœ… ë³„í‘œ ì¶”ê°€ ì„±ê³µ:', data.message);
                    return true;
                } else {
                    console.error('âŒ ë³„í‘œ ì¶”ê°€ ì‹¤íŒ¨:', data.error);
                    return false;
                }
            } catch (error) {
                console.error('âŒ ë³„í‘œ ì¶”ê°€ ì˜¤ë¥˜:', error);
                return false;
            }
        }

        // ë³„í‘œ ì œê±°
        async function removeStarred(messageId) {
            if (!confirm('ì´ ë©”ì‹œì§€ì˜ ë³„í‘œë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/starred/${messageId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    console.log('ë³„í‘œ ì œê±°ë¨');
                    loadStarredMessages(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ë³„í‘œ ì œê±° ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                console.error('ë³„í‘œ ì œê±° ì˜¤ë¥˜:', error);
                alert('ë³„í‘œ ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (ì´ë¯¸ ìˆìœ¼ë©´ ì œê±°í•´ë„ ë¨)
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ë³„í‘œ í† ê¸€
        async function toggleStar(notifId) {
            const starBtn = document.getElementById(`star-${notifId}`);
            const notifDiv = document.getElementById(notifId);
            const isStarred = starBtn.textContent.trim() === 'â­';

            if (isStarred) {
                // ë³„í‘œ ì œê±° - ì•„ì§ message_idê°€ ì—†ìœ¼ë¯€ë¡œ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
                alert('ë³„í‘œ ì œê±°ëŠ” "â­ ì¤‘ìš” ë©”ì‹œì§€" íƒ­ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            // DOMì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const messageData = {
                channel_id: notifDiv.getAttribute('data-channel-id') || '',
                channel_name: notifDiv.getAttribute('data-channel-name') || '',
                ts: notifDiv.getAttribute('data-ts') || '',
                user: notifDiv.getAttribute('data-user') || '',
                text: notifDiv.getAttribute('data-text') || '',
                time: notifDiv.getAttribute('data-time') || '',
                reason: notifDiv.getAttribute('data-reason') || '',
                priority: notifDiv.getAttribute('data-priority') || 'normal'
            };

            console.log('ë³„í‘œ ì¶”ê°€ ì‹œë„:', messageData);

            const success = await addStarred(messageData);

            if (success) {
                starBtn.textContent = 'â­';
                starBtn.style.background = '#fff9e6';
                starBtn.style.borderColor = '#ffc107';
                starBtn.style.color = '#ffc107';
                alert('â­ ì¤‘ìš” ë©”ì‹œì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                alert('ë³„í‘œ ì¶”ê°€ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
            }
        }

        // í˜ì´ì§€ ë– ë‚  ë•Œ ì •ë¦¬
        window.onbeforeunload = function() {
            if (monitoring) {
                stopMonitoring();
            }
            if (channelEventSource) {
                stopChannelStream();
            }
        };
    </script>
</body>
</html>
